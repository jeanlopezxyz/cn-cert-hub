---
import Layout from '@/layouts/Layout.astro';
import { getPageI18n } from '@/i18n';
import { fetchAllNews, getFallbackNewsData, type NewsItem } from '@/data/news';
import { getMonthKey, formatMonthLabel } from '@/utils';
import NewsCard from '@/components/news/NewsCard.astro';
import Icon from '@/components/ui/Icon.astro';
import CardSection from '@/components/ui/CardSection.astro';

const { lang, t, basePath } = getPageI18n(Astro.url);

/**
 * Fetch news data with fallback
 */
async function getNewsData() {
  try {
    return await fetchAllNews();
  } catch {
    // Silent fallback - RSS fetch errors are expected
    return getFallbackNewsData();
  }
}

/**
 * Group news items by month/year
 */
function groupNewsByMonth(items: NewsItem[], locale: string) {
  return items.reduce(
    (acc, item) => {
      const date = new Date(item.publishedAt);
      const key = getMonthKey(date);
      const label = formatMonthLabel(date, locale);

      if (!acc[key]) {
        acc[key] = { label, items: [] };
      }
      acc[key].items.push(item);
      return acc;
    },
    {} as Record<string, { label: string; items: NewsItem[] }>
  );
}

/**
 * Sort month keys in descending order (newest first)
 */
function sortKeysDescending(keys: string[]): string[] {
  return keys.sort((a, b) => b.localeCompare(a));
}

const newsData = await getNewsData();
const groupedNews = groupNewsByMonth(newsData.items, lang);
const sortedKeys = sortKeysDescending(Object.keys(groupedNews));
---

<Layout title={t('news.archivesTitle')} lang={lang} showSidebar={true}>
  <div class="w-full px-4 sm:px-6 lg:px-8 xl:px-8 2xl:px-12 3xl:px-16 py-6 sm:py-8">
    <!-- Back Link -->
    <a
      href={`${basePath}/news`}
      class="inline-flex items-center gap-2 text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white mb-6 transition-colors"
    >
      <Icon name="chevronLeft" size="md" strokeWidth={2} />
      {t('news.backToNews')}
    </a>

    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold text-neutral-900 dark:text-white mb-2">
        {t('news.archivesTitle')}
      </h1>
      <p class="text-base text-neutral-600 dark:text-neutral-400">
        {t('news.archivesSubtitle')}
      </p>
      <p class="text-sm text-neutral-500 dark:text-neutral-500 mt-2">
        {newsData.items.length}
        {t('news.articles')}
      </p>
    </div>

    <!-- Archives by Month -->
    <div class="space-y-8">
      {
        sortedKeys.map((key) => {
          const group = groupedNews[key];
          if (!group) return null;
          return (
            <section>
              <h2 class="text-xl font-bold text-neutral-900 dark:text-white mb-4 flex items-center gap-3">
                <span class="w-10 h-10 rounded-xl bg-neutral-200 dark:bg-neutral-700 flex items-center justify-center text-neutral-600 dark:text-neutral-300">
                  <Icon name="calendar" size="md" strokeWidth={2} />
                </span>
                {group.label}
                <span class="text-sm font-normal text-neutral-500 dark:text-neutral-400">
                  ({group.items.length})
                </span>
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-5">
                {group.items.map((item, index) => (
                  <NewsCard item={item} lang={lang} index={index} />
                ))}
              </div>
            </section>
          );
        })
      }
    </div>

    <!-- Empty State -->
    {
      newsData.items.length === 0 && (
        <CardSection class="text-center p-8">
          <div class="w-12 h-12 mx-auto mb-4 text-neutral-400">
            <Icon name="archive" size="xl" strokeWidth={1.5} />
          </div>
          <p class="text-neutral-600 dark:text-neutral-400">{t('news.noNews')}</p>
        </CardSection>
      )
    }
  </div>
</Layout>
